# Patterns & Anti-Patterns

Learn proven patterns for building reliable Inngest functions and avoid common pitfalls that can lead to brittle, hard-to-debug workflows. These patterns are based on [durable execution](https://www.inngest.com/blog/principles-of-durable-execution) principles and production experience with [event-driven architectures](https://en.wikipedia.org/wiki/Event-driven_architecture).

## Function Design Patterns

### Use Descriptive Step Names

[Step names](https://www.inngest.com/docs/features/inngest-functions/steps-workflows#naming-steps) appear in logs, debugging interfaces ([Inngest Dev Server](https://www.inngest.com/docs/dev-server)), and error messages. Make them meaningful for better [observability](https://www.inngest.com/docs/platform/monitor).

```typescript
// ✅ Good - Clear, descriptive names
await step.run("validate-order-items", () => validateOrderItems(items));
await step.run("calculate-shipping-cost", () => calculateShipping(address));

// ❌ Bad - Generic, uninformative names  
await step.run("step1", () => validateOrderItems(items));
```

### Keep Steps Atomic
Each [`step.run()`](/concepts/steps#steprun---execute--retry) should perform one logical unit of work that can be safely retried. This improves error isolation and makes workflows easier to debug. See more in [Steps Best Practices](/concepts/steps#step-best-practices).

```typescript
// ✅ Good - Atomic operations
await step.run("create-user-record", () => db.users.create(userData));
await step.run("send-welcome-email", () => emailService.sendWelcome(user.email));

// ❌ Bad - Multiple operations in one step
await step.run("create-user-and-send-email", async () => {
  const user = await db.users.create(userData);
  await emailService.sendWelcome(user.email);
});
```

### Idempotent Step Design
Ensure your step logic can be safely executed multiple times without unintended side effects, especially when interacting with external systems. Use techniques like idempotency keys if the external API supports them. [Learn about Idempotency](https://en.wikipedia.org/wiki/Idempotence#Computer_science).

```typescript
// ✅ Good - Using idempotency key for Stripe
await step.run("charge-customer-card", () => 
  stripe.charges.create({
    amount: order.total,
    currency: "usd",
    customer: order.customerId
  }, { 
    idempotencyKey: `charge-${order.id}` // Stripe handles retries safely
  })
);
```

### Explicit Data Passing Between Steps
Pass necessary data as arguments to subsequent steps or retrieve it within a step. Avoid relying on mutable variables scoped outside your step functions, as their state is not preserved across retries or distributed executions. See [Passing Data in Steps](https://www.inngest.com/docs/features/inngest-functions/steps-workflows#passing-data-between-steps).

### Function Composition
Break complex workflows into smaller, reusable [Inngest functions](/concepts/functions) and orchestrate them using [`step.invoke()`](/concepts/steps#stepinvoke---composable-workflows) or [`step.sendEvent()`](/concepts/steps#step-tools) for event-driven chaining.

*See: [Function Composition in Functions](/concepts/functions#function-composition) and [Invoking Functions Guide](https://www.inngest.com/docs/guides/invoking-functions-directly).*

## Event Handling Patterns

### Use Specific Event Names
Use clear, hierarchical event names (e.g., `user/signed_up`, `order/payment_succeeded`). This helps with [event matching](/concepts/events#event-matching-and-filtering) and makes your system easier to understand and debug. [See Event Naming Tips](https://www.inngest.com/docs/features/events-triggers/event-format#tips-for-event-naming).

### Event Fan-Out
One event triggers multiple independent functions. This is a common pattern for decoupling processes. For example, a `user/signed_up` event might trigger `SendWelcomeEmail`, `UpdateAnalytics`, and `StartOnboardingWorkflow` functions.

*See: [Event Fan-Out in Events](/concepts/events#fan-out) and [Fan-out Guide](https://www.inngest.com/docs/guides/fan-out-jobs).*

### Event Versioning (Conceptual)
While Inngest functions have [versioning](https://www.inngest.com/docs/features/inngest-functions/versioning), consider how you'll handle changes to event schemas over time. Strategies include tolerant readers, version numbers in event names (`user/signed_up/v2`), or transformation functions.

## Error Handling in Steps

Effective error handling is crucial for robust workflows.

### Leverage Automatic Retries
Inngest automatically retries failed steps with [exponential backoff](https://en.wikipedia.org/wiki/Exponential_backoff). For most transient errors (network issues, temporary API outages), this is often sufficient. [See Inngest Retry Docs](https://www.inngest.com/docs/features/inngest-functions/error-retries/retries).

### Custom `try/catch` for Business Logic Errors
Wrap step operations in `try/catch` blocks to handle specific business logic errors (e.g., payment declined due to insufficient funds vs. API error). This allows you to implement custom recovery logic or send specific notifications.

```typescript
await step.run("process-payment", async () => {
  try {
    return await paymentGateway.charge(order.amount, cardDetails);
  } catch (error) {
    if (error.code === "card_declined") {
      await step.sendEvent("notify-user-card-declined", { // Triggers another function
        name: "user/payment_declined", 
        data: { userId: order.userId, reason: error.message }
      });
      // Optionally, re-throw a NonRetriableError to stop retries for this step
      throw new NonRetriableError("Card was declined."); // See: https://www.inngest.com/docs/reference/typescript/inngest#nonretriableerror
    }
    throw error; // Re-throw other errors for Inngest to retry
  }
});
```

### `onFailure` Handler
Use the function-level [`onFailure` handler](https://www.inngest.com/docs/reference/functions/handling-failures) for cleanup, alerting, or dead-letter queueing if all retries for a function are exhausted.

## Flow Control Patterns

Refer to the **[Flow Control concept page](/concepts/flow-control)** for detailed patterns on:
- [Concurrency Control](/concepts/flow-control#concurrency-control)
- [Rate Limiting](/concepts/flow-control#rate-limiting)
- [Event Batching](/concepts/flow-control#event-batching)
- [Debouncing](/concepts/flow-control#debouncing)

## Testing Functions

### Unit Testing with Mocks
Use `inngest/test` utilities like [`createStepTools()`](https://www.inngest.com/docs/reference/testing#createsteptools) to mock step behaviors and test your function's logic in isolation. [See official Testing Guide](https://www.inngest.com/docs/reference/testing).

### Integration Testing with Test Engine
Use [`InngestTestEngine`](https://www.inngest.com/docs/reference/testing#inngesttestengine) from `inngest/test` to run your functions against a local test engine, verifying event triggers, step execution, and overall workflow behavior.

*See more: [Testing Functions in Functions Concept](/concepts/functions#testing-functions).*

## Anti-Patterns to Avoid

- **Non-Deterministic Logic in Steps**: Ensure that given the same input, a step's logic (especially conditional paths) behaves identically. Inngest relies on determinism for reliable retries. [Read about Determinism](https://en.wikipedia.org/wiki/Deterministic_algorithm).
- **Overly Large Event Payloads**: Keep event payloads concise. Fetch large data within steps if needed. [See Event Payload Best Practices](/concepts/events#event-payload-best-practices).
- **Ignoring Flow Control**: Not setting up [concurrency](/concepts/flow-control#concurrency-control) or [rate limits](/concepts/flow-control#rate-limiting) can overwhelm downstream services.
- **Shared Mutable State Across Steps**: Each step should be self-contained or explicitly pass data. State outside of step inputs/outputs is not reliably preserved across retries or distributed executions. [See Passing Data in Steps](/concepts/steps#step-best-practices).

## Next Steps

- Explore **[Real-World Examples](/quick-start/examples)** to see these patterns in action.
- Deepen your understanding of **[Core Concepts](/concepts)**.
- Consult the **[Official Inngest Guides](https://www.inngest.com/docs/guides)** for specific features. 